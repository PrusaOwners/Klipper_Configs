# DO NOT EDIT THIS FILE!
# YOU CAN OVERRIDE THE SETTINGS IN THE MAIN PRINTER.CFG

######################
# X MOTOR
######################

# Connect to X Motor Slot
[stepper_x]
step_pin: PC0
dir_pin: !PL0
enable_pin: !PA7
rotation_distance: 32      
microsteps: 16
full_steps_per_rotation: 200 
endstop_pin: tmc2130_stepper_x:virtual_endstop
position_endstop: 0
position_max: 250
homing_speed: 50
homing_retract_dist: 0

[tmc2130 stepper_x]
cs_pin: PG0
interpolate: True
run_current: .3
hold_current: .3
sense_resistor: 0.220
diag1_pin: !PK2
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 2
driver_PWM_AMPL: 230
driver_PWM_AUTOSCALE: True
driver_SGT: 2

######################
# Y MOTOR
######################

[stepper_y]
step_pin: PC1
dir_pin: PL1
enable_pin: !PA6
rotation_distance: 32           #16T Pulley, 2mm Belt Pitch
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
endstop_pin: tmc2130_stepper_y:virtual_endstop
position_endstop: -4
position_max: 210
position_min: -4
homing_speed: 50
homing_retract_dist: 0

[tmc2130 stepper_y]
cs_pin: PG2
interpolate: True
run_current: .35
hold_current: .35
sense_resistor: 0.220
diag1_pin: !PK7
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 2
driver_PWM_AMPL: 235
driver_PWM_AUTOSCALE: True
driver_SGT: 2

######################
# Z MOTORS
######################

[stepper_z]
step_pin: PC2
dir_pin: !PL2
enable_pin: !PA5
rotation_distance: 8            # Rotation Distance for TR8x8 = 8, TR8x4 = 4, TR8x2 = 2
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
endstop_pin: probe:z_virtual_endstop
position_max: 210
position_min: -2
homing_speed: 13.333

[tmc2130 stepper_z]
cs_pin: PK5
interpolate: True
run_current: .53
hold_current: .53
sense_resistor: 0.220
diag1_pin: !PK6
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 4
driver_PWM_AMPL: 200
driver_PWM_AUTOSCALE: True
driver_SGT: 4



######################
# HOTEND AND EXTRUDER
######################

# Connect motor to E0 Motor Slot (extruder)
[extruder]
step_pin: PC3
dir_pin: PL6 #Direction for Stock
enable_pin: !PA4

# Connect Heater Cart to HE0
heater_pin: PE5

# Connect Thermistor to TH0
sensor_type: ATC Semitec 104GT-2	#E3D Thermistor
sensor_pin: PF0

control: pid
pid_Kp: 16.13
pid_Ki: 1.1625
pid_Kd: 56.23

nozzle_diameter: 0.400
filament_diameter: 1.750
max_extrude_cross_section: 100
max_extrude_only_distance: 400
max_extrude_only_velocity: 200
max_extrude_only_accel: 5000.0
min_extrude_temp: 15
pressure_advance: 0
pressure_advance_smooth_time: 0.040
min_temp: 0
max_temp: 310


[tmc2130 extruder]
cs_pin: PK4
interpolate: True
run_current: .51
hold_current: .1
sense_resistor: 0.220
diag1_pin: !PK3
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 4
driver_PWM_AMPL: 240
driver_PWM_AUTOSCALE: True
driver_SGT: 3



######################
# PROBE
######################

[probe]
pin: PB4
x_offset: 23
y_offset: 5
z_offset: 0
speed: 10.0
samples: 3
sample_retract_dist: 0.8
samples_result: average
samples_tolerance: 0.05
samples_tolerance_retries: 3

######################
# FILAMENT SENSOR
######################

[filament_switch_sensor fsensor]
pause_on_runout: True
runout_gcode:
    M118 Filament Runout Detected
    M600
insert_gcode:
    M118 Filament Load Detected
    LOAD_FILAMENT
event_delay: 3.0
pause_delay: 0.01
switch_pin: !PK0


######################
# FANS
######################

# Connect Hotend Fan to FAN0
[heater_fan hotend_fan]
pin: PH5
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# Connect Part Cooling Fan to HE1
[fan]
pin: PH3

######################
# MK52 BED
######################
[heater_bed]
heater_pin: PG5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF2
min_temp: 0
max_temp: 125
control: pid
pid_Kp: 52.924
pid_Ki: 0.661
pid_Kd: 1059.794
min_temp: 0
max_temp: 125

######################
# DISPLAY
######################

[display]
lcd_type: hd44780
rs_pin: PD5
e_pin: PF7
d4_pin: PF5
d5_pin: PG4
d6_pin: PH7
d7_pin: PG3
encoder_pins: ^PJ1,^PJ2
click_pin: ^!PH6


######################
# MISC SETTINGS
######################
[force_move]
enable_force_move: TRUE

[gcode_macro Tram_Z]
gcode:
    {% set TRAM_CUR = 0.3 %}
	{% if printer["gcode_macro _stepper_type"].tmc2209|int == 1 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_x'] %}
	{% else %}
    {% set driver_config = printer.configfile.settings['tmc2130 stepper_x'] %}	
	{% endif %}
    {% set RUN_CUR = driver_config.run_current %}
    {% set HOLD_CUR = driver_config.hold_current %}
    G28
    G1 X125 Y105 F2000
    G1 Z208 F1000
    SET_KINEMATIC_POSITION Z=203
	SET_TMC_CURRENT STEPPER=stepper_z CURRENT={TRAM_CUR} HOLDCURRENT={TRAM_CUR}
    G1 Z208 F100
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={RUN_CUR} HOLDCURRENT={HOLD_CUR}
    G28 Z